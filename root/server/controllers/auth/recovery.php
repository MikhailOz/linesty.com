<?php
session_start();

include '../../configs/connect_users.php';
include '../../mail/send_mail.php';
include '../../configs/recaptcha.php';
include 'input_validation.php';

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
  $recaptcha_response = validateRecaptcha();
  validateInputs();

  if (isset($recaptcha_response['error'])) {
    $response = $recaptcha_response;
  } else {
    $email = trim($_POST['email'] ?? ''); 
    $query = "SELECT id, email, pass, verified FROM accounts WHERE email=?";
    $stmt = $pdo->prepare($query);
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    if (!$user) {
      $response = array(
        'error' => 'The account you are trying to access is invalid'
      );
    } else if ($user['verified'] == 'N') {
      $response = array(
        'error' => 'Verify your email before accessing the account'
      );
    } else {
      $current_time = time();
      $last_recovery_time = isset($_SESSION['last_recovery_time']) ? $_SESSION['last_recovery_time'] : 0;
      $recovery_time_limit = 3600; // Limit to 1 recovery attempt per hour

      if ($current_time - $last_recovery_time < $recovery_time_limit) {
        $response = array(
          'error' => 'Password recovery limit reached. Try again later'
        );
      } else {
        $recovery_token = bin2hex(random_bytes(40));
        $_SESSION['recovery_token'] = $recovery_token;
        $_SESSION['recovery_token_expiry'] = strtotime('+1 hour'); // Set expiration to 1 hour from now
        $_SESSION['email'] = $user['email'];
        $_SESSION['last_recovery_time'] = $current_time; // Store the timestamp of the current recovery request

        $reset_link = "http://{$_SERVER['SERVER_NAME']}/account/?recovery_token=" . $recovery_token;
        $message = "<html xmlns=\"http://www.w3.org/1999/xhtml\"><head><meta property=\"og:title\" content=\"\"><meta property=\"fb:page_id\" content=\"43929265776\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1,maximum-scale=1\"><meta name=\"referrer\" content=\"origin\"><!--[if gte mso 15]><xml><o:officedocumentsettings><o:allowpng><o:pixelsperinch>96</o:pixelsperinch></o:officedocumentsettings></xml><![endif]--><meta charset=\"UTF-8\"><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title></title><link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Merriweather+Sans:400,400i,700,700i,900,900i|Syncopate:400,400i,700,700i,900,900i\"><style>img{-ms-interpolation-mode:bicubic}table,td{mso-table-lspace:0;mso-table-rspace:0}.mceStandardButton,.mceStandardButton td,.mceStandardButton td a{mso-hide:all!important}a,blockquote,li,p,td{mso-line-height-rule:exactly}a,blockquote,body,li,p,table,td{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}@media only screen and (max-width:480px){a,blockquote,body,li,p,table,td{-webkit-text-size-adjust:none!important}}.mcnPreviewText{display:none!important}.bodyCell{margin:0 auto;padding:0;width:100%}.ExternalClass,.ExternalClass div,.ExternalClass font,.ExternalClass p,.ExternalClass span,.ExternalClass td{line-height:100%}.ReadMsgBody{width:100%}.ExternalClass{width:100%}a[x-apple-data-detectors]{color:inherit!important;text-decoration:none!important;font-size:inherit!important;font-family:inherit!important;font-weight:inherit!important;line-height:inherit!important}body{height:100%;margin:0;padding:0;width:100%;background:#fff}p{margin:0;padding:0}table{border-collapse:collapse}a,p,td{word-break:break-word}h1,h2,h3,h4,h5,h6{display:block;margin:0;padding:0}a img,img{border:0;height:auto;outline:0;text-decoration:none}a[href^=sms],a[href^=tel]{color:inherit;cursor:default;text-decoration:none}li p{margin:0!important}.ProseMirror a{pointer-events:none}@media only screen and (max-width:480px){body{width:100%!important;min-width:100%!important}body.mobile-native{-webkit-user-select:none;user-select:none;transition:transform .2s ease-in;transform-origin:top center}body.mobile-native.selection-allowed .ProseMirror,body.mobile-native.selection-allowed a{user-select:auto;-webkit-user-select:auto}colgroup{display:none}img{height:auto!important}.mceWidthContainer{max-width:660px!important}.mceColumn{display:block!important;width:100%!important}.mceColumn-forceSpan{display:table-cell!important;width:auto!important}.mceBlockContainer{padding-right:16px!important;padding-left:16px!important}.mceSpacing-24{padding-right:16px!important;padding-left:16px!important}.mceFooterSection .mceText,.mceFooterSection .mceText p{font-size:12px!important;line-height:140%!important}.mceText,.mceText p{font-size:12px!important;line-height:140%!important}h1{font-size:30px!important;line-height:120%!important}h2{font-size:26px!important;line-height:120%!important}h3{font-size:20px!important;line-height:125%!important}h4{font-size:18px!important;line-height:125%!important}.ProseMirror{-webkit-user-modify:read-write-plaintext-only;user-modify:read-write-plaintext-only}}@media only screen and (max-width:640px){.mceClusterLayout td{padding:4px!important}}div[contenteditable=true]{outline:0}.ProseMirror .empty-node,.ProseMirror:empty{position:relative}.ProseMirror .empty-node::before,.ProseMirror:empty::before{position:absolute;left:0;right:0;color:rgba(0,0,0,.2);cursor:text}.ProseMirror .empty-node:hover::before,.ProseMirror:empty:hover::before{color:rgba(0,0,0,.3)}.ProseMirror h1.empty-node::before{content:'Heading'}.ProseMirror p.empty-node:only-child::before,.ProseMirror:empty::before{content:'Start typing...'}a .ProseMirror p.empty-node::before,a .ProseMirror:empty::before{content:''}.ProseMirror,.mceText{white-space:pre-wrap}#bodyTable,body{background-color:#eee}.mceLabel,.mceText{font-family:\"Helvetica Neue\",Helvetica,Arial,Verdana,sans-serif}.mceLabel,.mceText{color:#000}.mceText p{margin-bottom:0}.mceText label{margin-bottom:0}.mceText input{margin-bottom:0}.mceSpacing-24 .mceInput+.mceErrorMessage{margin-top:-12px}.mceText p{margin-bottom:0}.mceText label{margin-bottom:0}.mceText input{margin-bottom:0}.mceSpacing-12 .mceInput+.mceErrorMessage{margin-top:-6px}.mceInput{background-color:transparent;border:2px solid #d0d0d0;width:60%;color:#4d4d4d;display:block}.mceInput[type=checkbox],.mceInput[type=radio]{float:left;margin-right:12px;display:inline;width:auto!important}.mceLabel>.mceInput{margin-bottom:0;margin-top:2px}.mceLabel{display:block}.mceText p{color:#000;font-family:\"Helvetica Neue\",Helvetica,Arial,Verdana,sans-serif;font-size:14px;font-weight:400;line-height:1.25;text-align:left;letter-spacing:0;direction:ltr}@media only screen and (max-width:480px){.mceText p{font-size:14px!important;line-height:1.25!important}}@media only screen and (max-width:480px){.mceBlockContainer{padding-left:24px!important;font-size:20px;padding-right:24px!important}}#dataBlockId-53 h1,#dataBlockId-53 h2,#dataBlockId-53 h3,#dataBlockId-53 h4,#dataBlockId-53 p,#dataBlockId-53 ul{text-align:start}#dataBlockId-53 h1,#dataBlockId-53 h2,#dataBlockId-53 h3,#dataBlockId-53 h4,#dataBlockId-53 p,#dataBlockId-53 ul{color:#000;text-align:center}@media only screen and (max-width:480px){.mobileClass-4{padding-left:12!important;padding-top:0!important;padding-right:12!important}.mobileClass-4{padding-left:12!important;padding-top:0!important;padding-right:12!important}.mobileClass-4{padding-left:12!important;padding-top:0!important;padding-right:12!important}}</style><center><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" id=\"bodyTable\" style=\"background-color:#eee\"><tbody><tr><td class=\"bodyCell\" align=\"center\" valign=\"top\"><table id=\"root\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tbody data-block-id=\"57\" class=\"mceWrapper\"><tr><td align=\"center\" valign=\"top\" class=\"mceWrapperOuter\"><!--[if (gte mso 9)|(IE)]><table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"660\" style=\"width:660px\"><tr><td><![endif]--><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width:660px\" role=\"presentation\"><tbody><tr><td style=\"background-color:#fff;background-position:center;background-repeat:no-repeat;background-size:cover\" class=\"mceWrapperInner\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"56\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:0\" class=\"mceColumn\" data-block-id=\"-10\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"background-color:#0f0c0c;padding-top:12px;padding-bottom:12px\" class=\"mceBlockContainer\" align=\"center\" valign=\"top\"><a href=\"https://linesty.com\" style=\"display:block\" target=\"_blank\" data-block-id=\"129\"><img width=\"254\" style=\"border:0;width:254px;height:auto;max-width:100%;display:block\" alt=\"Logo\" src=\"https://dim.mcusercontent.com/cs/71e1cd7b3edbf2583931ee0d2/images/c231be45-3e4c-101d-dc0d-14bfaaee4943.png?w=361&dpr=2\" class=\"\"></a></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"130\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:0;padding-bottom:12px;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"65\" class=\"mceText\" id=\"dataBlockId-65\" style=\"width:100%\"><p style=\"text-align:center\" class=\"last-child\"><strong><span style=\"color:#000\"><span style=\"font-size:30px\"><span style=\"font-family:'Helvetica Neue',Helvetica,Arial,Verdana,sans-serif\">Welcome to our Community</span></span></span></strong></p></div></td></tr><tr><td style=\"padding-top:0;padding-bottom:0;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"14\" class=\"mceText\" id=\"dataBlockId-14\" style=\"width:100%\"><p style=\"text-align:center\" class=\"last-child\"><span style=\"font-family:'Helvetica Neue',Helvetica,Arial,Verdana,sans-serif\">We have received a request to reset the password for your account. To proceed with the password recovery process, please follow the steps outlined below.</span></p></div></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"70\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" align=\"center\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" data-block-id=\"69\"><tbody><tr class=\"mceStandardButton\"><td style=\"background-color:#7551ff;border-radius:0;text-align:center\" class=\"mceButton\" valign=\"top\"><a href=\"https://" . $reset_link . "\" target=\"_blank\" style=\"background-color:#7551ff;border-radius:0;border:1px solid #7551ff;color:#fff;display:block;font-family:'Helvetica Neue',Helvetica,Arial,Verdana,sans-serif;font-size:16px;font-weight:400;font-style:normal;padding:12px 28px;text-decoration:none;min-width:30px;text-align:center;direction:ltr;letter-spacing:0\">Reset the password</a></td></tr><tr><!--[if mso]><td align=\"center\"><v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"https://" . $reset_link . "\" style=\"v-text-anchor:middle;width:244.08px;height:44px\" arcsize=\"0%\" strokecolor=\"#7551ff\" strokeweight=\"1px\" fillcolor=\"#7551ff\"><v:stroke dashstyle=\"solid\"><w:anchorlock><center style=\"color:#fff;display:block;font-family:'Helvetica Neue',Helvetica,Arial,Verdana,sans-serif;font-size:16;font-style:normal;font-weight:400;letter-spacing:0;text-decoration:none;text-align:center;direction:ltr\">Reset the passwords</center></v:roundrect></td><![endif]--></tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"79\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:0;padding-bottom:0;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"81\" class=\"mceText\" id=\"dataBlockId-81\" style=\"width:100%\"><p style=\"text-align:center\">Thank you for your cooperation.</p><p style=\"text-align:center\" class=\"last-child\">Best regards, Linesty Team</p></div></td></tr><tr><td style=\"background-color:transparent;padding-top:20px;padding-bottom:4px;padding-right:24px;padding-left:24px\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"66\"><tbody><tr><td style=\"min-width:100%;border-top:2px solid #000\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:12px;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceLayoutContainer\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"51\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"24\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"margin-bottom:24px\" class=\"mceColumn\" data-block-id=\"-9\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td align=\"center\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"\" role=\"presentation\" class=\"mceClusterLayout\" data-block-id=\"-8\"><tbody><tr><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://facebook.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-5\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"Facebook icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Ffacebook-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://instagram.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-6\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"Instagram icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Finstagram-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://tiktok.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-7\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"TikTok icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Ftiktok-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceLayoutContainer\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"55\" id=\"section_bc6a84ed3350dc1906e44867c08799c0\" class=\"mceFooterSection\"><tbody><tr class=\"mceRow\"><td style=\"background-color:transparent;background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"12\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:0;margin-bottom:12px\" class=\"mceColumn\" data-block-id=\"-3\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:20px;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" align=\"left\" valign=\"top\"><div data-block-id=\"53\" class=\"mceText\" id=\"dataBlockId-53\" style=\"width:100%\"><p><br></p><p class=\"last-child\"><em><span style=\"font-size:15px\"><span style=\"font-family:'Helvetica Neue',Helvetica,Arial,Verdana,sans-serif\">© Linesty. All rights reserved</span></span></em></p></div></td></tr><tr><td class=\"mceLayoutContainer\" align=\"left\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"-2\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover;padding-top:0;padding-bottom:0\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"24\" width=\"100%\" role=\"presentation\"><tbody></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table><!--[if (gte mso 9)|(IE)]><![endif]--></td></tr></tbody></table></td></tr></tbody></table></center></html>";
        sendMail($user['email'], 'Reset Your Password', $message);

        $response = array(
          'success' => 'The password reset link was sent to your email'
        );
      }
    }
  }

  sleep(1);
  header('Content-Type: application/json');
  echo json_encode($response);
}
?>