<?php
session_start();

include '../../configs/connect_users.php';
include '../../mail/send_mail.php';
include '../../configs/recaptcha.php';
include 'input_validation.php';

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
  $recaptcha_response = validateRecaptcha();
  validateInputs();

  if (isset($recaptcha_response['error'])) {
    $response = $recaptcha_response;
  } else {
    $email = trim($_POST['email'] ?? ''); 
    $query = "SELECT id, email, pass, verified FROM accounts WHERE email=?";
    $stmt = $pdo->prepare($query);
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    if (!$user) {
      $response = array(
        'error' => 'The account you are trying to access is invalid'
      );
    } else if ($user['verified'] == 'N') {
      $response = array(
        'error' => 'Verify your email before accessing the account'
      );
    } else {
      $current_time = time();
      $last_recovery_time = isset($_SESSION['last_recovery_time']) ? $_SESSION['last_recovery_time'] : 0;
      $recovery_time_limit = 3600; // Limit to 1 recovery attempt per hour

      if ($current_time - $last_recovery_time < $recovery_time_limit) {
        $response = array(
          'error' => 'Password recovery limit reached. Try again later'
        );
      } else {
        $recovery_token = bin2hex(random_bytes(40));
        $_SESSION['recovery_token'] = $recovery_token;
        $_SESSION['recovery_token_expiry'] = strtotime('+1 hour'); // Set expiration to 1 hour from now
        $_SESSION['email'] = $user['email'];
        $_SESSION['last_recovery_time'] = $current_time; // Store the timestamp of the current recovery request

        $reset_link = "http://{$_SERVER['SERVER_NAME']}/account/?recovery_token=" . $recovery_token;
        $message = "<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\"><head><!--[if gte mso 15]> <xml> <o:OfficeDocumentSettings> <o:AllowPNG/> <o:PixelsPerInch>96</o:PixelsPerInch> </o:OfficeDocumentSettings> </xml><![endif]--> <meta charset=\"UTF-8\"> <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\"> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"> <title>Password Recovery</title> <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Syncopate:400,400i,700,700i,900,900i|Work+Sans:400,400i,700,700i,900,900i\"><style>img{-ms-interpolation-mode:bicubic;}table, td{mso-table-lspace:0pt; mso-table-rspace:0pt;}.mceStandardButton, .mceStandardButton td, .mceStandardButton td a{mso-hide:all !important;}p, a, li, td, blockquote{mso-line-height-rule:exactly;}p, a, li, td, body, table, blockquote{-ms-text-size-adjust:100%; -webkit-text-size-adjust:100%;}@media only screen and (max-width: 480px){body, table, td, p, a, li, blockquote{-webkit-text-size-adjust:none !important;}}.mcnPreviewText{display: none !important;}.bodyCell{margin:0 auto; padding:0; width:100%;}.ExternalClass, .ExternalClass p, .ExternalClass td, .ExternalClass div, .ExternalClass span, .ExternalClass font{line-height:100%;}.ReadMsgBody{width:100%;}.ExternalClass{width:100%;}a[x-apple-data-detectors]{color:inherit !important; text-decoration:none !important; font-size:inherit !important; font-family:inherit !important; font-weight:inherit !important; line-height:inherit !important;}body{height:100%; margin:0; padding:0; width:100%; background: #ffffff;}p{margin:0; padding:0;}table{border-collapse:collapse;}td, p, a{word-break:break-word;}h1, h2, h3, h4, h5, h6{display:block; margin:0; padding:0;}img, a img{border:0; height:auto; outline:none; text-decoration:none;}a[href^=\"tel\"], a[href^=\"sms\"]{color:inherit; cursor:default; text-decoration:none;}li p{margin: 0 !important;}.ProseMirror a{pointer-events: none;}@media only screen and (max-width: 480px){body{width:100% !important; min-width:100% !important;}body.mobile-native{-webkit-user-select: none; user-select: none; transition: transform 0.2s ease-in; transform-origin: top center;}body.mobile-native.selection-allowed a, body.mobile-native.selection-allowed .ProseMirror{user-select: auto; -webkit-user-select: auto;}colgroup{display: none;}img{height: auto !important;}.mceWidthContainer{max-width: 660px !important;}.mceColumn{display: block !important; width: 100% !important;}.mceColumn-forceSpan{display: table-cell !important; width: auto !important;}.mceBlockContainer{padding-right:16px !important; padding-left:16px !important;}.mceSpacing-24{padding-right:16px !important; padding-left:16px !important;}.mceFooterSection .mceText, .mceFooterSection .mceText p{font-size: 16px !important; line-height: 140% !important;}.mceText, .mceText p{font-size: 16px !important; line-height: 140% !important;}h1{font-size: 30px !important; line-height: 120% !important;}h2{font-size: 26px !important; line-height: 120% !important;}h3{font-size: 20px !important; line-height: 125% !important;}h4{font-size: 18px !important; line-height: 125% !important;}.ProseMirror{-webkit-user-modify: read-write-plaintext-only; user-modify: read-write-plaintext-only;}}@media only screen and (max-width: 640px){.mceClusterLayout td{padding: 4px !important;}}div[contenteditable=\"true\"]{outline: 0;}.ProseMirror .empty-node, .ProseMirror:empty{position: relative;}.ProseMirror .empty-node::before, .ProseMirror:empty::before{position: absolute; left: 0; right: 0; color: rgba(0,0,0,0.2); cursor: text;}.ProseMirror .empty-node:hover::before, .ProseMirror:empty:hover::before{color: rgba(0,0,0,0.3);}.ProseMirror h1.empty-node::before{content: 'Heading';}.ProseMirror p.empty-node:only-child::before, .ProseMirror:empty::before{content: 'Start typing...';}a .ProseMirror p.empty-node::before, a .ProseMirror:empty::before{content: '';}.mceText, .ProseMirror{white-space: pre-wrap;}body, #bodyTable{background-color: rgb(238, 238, 238);}.mceText, .mceLabel{font-family: Verdana, Geneva, sans-serif;}.mceText, .mceLabel{color: rgb(0, 0, 0);}.mceText h1{margin-bottom: 0px;}.mceText h4{margin-bottom: 0px;}.mceText p{margin-bottom: 0px;}.mceText label{margin-bottom: 0px;}.mceText input{margin-bottom: 0px;}.mceSpacing-24 .mceInput + .mceErrorMessage{margin-top: -12px;}.mceText h1{margin-bottom: 0px;}.mceText h4{margin-bottom: 0px;}.mceText p{margin-bottom: 0px;}.mceText label{margin-bottom: 0px;}.mceText input{margin-bottom: 0px;}.mceSpacing-12 .mceInput + .mceErrorMessage{margin-top: -6px;}.mceInput{background-color: transparent; border: 2px solid rgb(208, 208, 208); width: 60%; color: rgb(77, 77, 77); display: block;}.mceInput[type=\"radio\"], .mceInput[type=\"checkbox\"]{float: left; margin-right: 12px; display: inline; width: auto !important;}.mceLabel > .mceInput{margin-bottom: 0px; margin-top: 2px;}.mceLabel{display: block;}.mceText p{color: rgb(0, 0, 0); font-family: Verdana, Geneva, sans-serif; font-size: 14px; font-weight: normal; line-height: 1.5; text-align: left; letter-spacing: 0px; direction: ltr;}.mceText h1{color: rgb(0, 0, 0); font-family: \"Work Sans\", sans-serif; font-size: 60px; font-weight: bold; line-height: 1; text-align: left; letter-spacing: 0px; direction: ltr;}.mceText h4{color: rgb(0, 0, 0); font-family: Syncopate, \"Helvetica Neue\", Helvetica, Arial, sans-serif; font-size: 40px; font-weight: bold; line-height: 1.5; text-align: left; letter-spacing: 0px; direction: ltr;}@media only screen and (max-width: 480px){.mceText p{font-size: 16px !important; line-height: 1.5 !important;}}@media only screen and (max-width: 480px){.mceText h1{font-size: 31px !important; line-height: 1 !important;}}@media only screen and (max-width: 480px){.mceText h4{font-size: 16px !important; line-height: 1.5 !important;}}@media only screen and (max-width: 480px){.mceBlockContainer{padding-left: 24px !important; padding-right: 24px !important;}}#dataBlockId-53 p, #dataBlockId-53 h1, #dataBlockId-53 h2, #dataBlockId-53 h3, #dataBlockId-53 h4, #dataBlockId-53 ul{text-align: start;}#dataBlockId-53 p, #dataBlockId-53 h1, #dataBlockId-53 h2, #dataBlockId-53 h3, #dataBlockId-53 h4, #dataBlockId-53 ul{color: rgb(0, 0, 0); text-align: center;}@media only screen and (max-width: 480px){.mobileClass-4{padding-left: 12 !important;padding-top: 0 !important;padding-right: 12 !important;}.mobileClass-4{padding-left: 12 !important;padding-top: 0 !important;padding-right: 12 !important;}.mobileClass-4{padding-left: 12 !important;padding-top: 0 !important;padding-right: 12 !important;}}</style><script async=\"\" crossorigin=\"anonymous\" src=\"https://edge.fullstory.com/s/fs.js\"></script></head> <body> <span class=\"mcnPreviewText\" style=\"display:none; font-size:0px; line-height:0px; max-height:0px; max-width:0px; opacity:0; overflow:hidden; visibility:hidden; mso-hide:all;\">*|MC_PREVIEW_TEXT|*</span> <center> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" id=\"bodyTable\" style=\"background-color: rgb(238, 238, 238);\"> <tbody><tr> <td class=\"bodyCell\" align=\"center\" valign=\"top\"> <table id=\"root\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tbody data-block-id=\"57\" class=\"mceWrapper\"><tr><td align=\"center\" valign=\"top\" class=\"mceWrapperOuter\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width:660px\" role=\"presentation\"><tbody><tr><td style=\"background-color:#ffffff;background-position:center;background-repeat:no-repeat;background-size:cover\" class=\"mceWrapperInner\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"56\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:0\" class=\"mceColumn\" data-block-id=\"-10\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"background-color:#ffffff;padding-top:25px;padding-bottom:0;padding-right:24px;padding-left:25px\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"64\" class=\"mceText\" id=\"dataBlockId-64\" style=\"width:100%\"><h4 class=\"last-child\"><span style=\"font-size: 43px\"><span style=\"font-family: 'Syncopate', 'Helvetica Neue', Helvetica, Arial, sans-serif\">Linesty</span></span></h4></div></td></tr><tr><td style=\"background-color:transparent;padding-top:20px;padding-bottom:8px;padding-right:24px;padding-left:24px\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"67\"><tbody><tr><td style=\"min-width:100%;border-top:2px solid #000000\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:16px;padding-bottom:12px;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"65\" class=\"mceText\" id=\"dataBlockId-65\" style=\"width:100%\"><h1 style=\"text-align: center;\" class=\"last-child\"><span style=\"font-size: 32px\">Recover your Password</span></h1></div></td></tr><tr><td style=\"padding-top:0;padding-bottom:0;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"14\" class=\"mceText\" id=\"dataBlockId-14\" style=\"width:100%\"><p style=\"text-align: center;\" class=\"last-child\">We have received a request to reset the password for your account. To proceed with the password recovery process, please follow the steps outlined below.</p></div></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"70\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:6px;padding-bottom:6px;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" align=\"center\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width:282px\" role=\"presentation\" data-block-id=\"69\"><tbody><tr class=\"mceStandardButton\"><td style=\"background-color:#7551ff;border-radius:6px;text-align:center\" class=\"mceButton\" valign=\"top\"><a href=\"" . $reset_link . "\" target=\"_blank\" style=\"background-color:#7551ff;border-radius:6px;border:1px solid #7551ff;color:#ffffff;display:block;font-family:Verdana, Geneva, sans-serif;font-size:16px;font-weight:normal;font-style:normal;padding:12px 28px;text-decoration:none;min-width:30px;text-align:center;direction:ltr;letter-spacing:0px\">Reset the password</a></td></tr><tr><!--[if mso]> <td align=\"center\"> <v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"\" style=\"v-text-anchor:middle; width:282px; height:44.67px;\" arcsize=\"2%\" strokecolor=\"#7551ff\" strokeweight=\"1px\" fillcolor=\"#7551ff\"> <v:stroke dashstyle=\"solid\"/> <w:anchorlock/> <center style=\" color: #ffffff; display: block; font-family: Verdana, Geneva, sans-serif; font-size: 16; font-style: normal; font-weight: normal; letter-spacing: 0px; text-decoration: none; text-align: center; direction: ltr;\" > Recover your password </center> </v:roundrect> </td><![endif]--> </tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"79\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:0;padding-bottom:0;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" valign=\"top\"><div data-block-id=\"81\" class=\"mceText\" id=\"dataBlockId-81\" style=\"width:100%\"><p style=\"text-align: center;\">Thank you for your cooperation.</p><p style=\"text-align: center;\" class=\"last-child\">Best regards, Linesty Team</p></div></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"128\"><tbody><tr><td style=\"min-width:100%;border-top:20px solid transparent\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:20px;padding-bottom:20px;padding-right:24px;padding-left:24px\" class=\"mceBlockContainer\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color:transparent\" role=\"presentation\" data-block-id=\"66\"><tbody><tr><td style=\"min-width:100%;border-top:2px solid #000000\" valign=\"top\"></td></tr></tbody></table></td></tr><tr><td style=\"padding-top:12px;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceLayoutContainer\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"51\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"24\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"margin-bottom:24px\" class=\"mceColumn\" data-block-id=\"-9\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td align=\"center\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"\" role=\"presentation\" class=\"mceClusterLayout\" data-block-id=\"-8\"><tbody><tr><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://facebook.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-5\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"Facebook icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Ffacebook-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://instagram.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-6\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"Instagram icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Finstagram-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td><td style=\"padding-left:12px;padding-top:0;padding-right:12px\" data-breakpoint=\"4\" valign=\"top\" class=\"mobileClass-4\"><a href=\"https://tiktok.com/\" style=\"display:block\" target=\"_blank\" data-block-id=\"-7\"><img width=\"32\" style=\"border:0;width:32px;height:auto;max-width:100%;display:block\" alt=\"TikTok icon\" src=\"https://dim.mcusercontent.com/https/cdn-images.mailchimp.com%2Ficons%2Fsocial-block-v3%2Fblock-icons-v3%2Ftiktok-outline-dark-40.png?w=32&amp;dpr=2\" class=\"\"></a></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr><tr><td style=\"background-color:transparent;padding-top:0;padding-bottom:0;padding-right:0;padding-left:0\" class=\"mceLayoutContainer\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"55\" id=\"section_0f36ff15897e593990ac1350b7dc8335\" class=\"mceFooterSection\"><tbody><tr class=\"mceRow\"><td style=\"background-color:transparent;background-position:center;background-repeat:no-repeat;background-size:cover\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"12\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:0;margin-bottom:12px\" class=\"mceColumn\" data-block-id=\"-3\" valign=\"top\" colspan=\"12\" width=\"100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\"><tbody><tr><td style=\"padding-top:0;padding-bottom:20px;padding-right:45px;padding-left:45px\" class=\"mceBlockContainer\" align=\"left\" valign=\"top\"><div data-block-id=\"53\" class=\"mceText\" id=\"dataBlockId-53\" style=\"width:100%\"><p><br></p><p class=\"last-child\"><span style=\"font-size: 15px\">© Linesty. All rights reserved</span></p></div></td></tr><tr><td class=\"mceLayoutContainer\" align=\"left\" valign=\"top\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" role=\"presentation\" data-block-id=\"-2\"><tbody><tr class=\"mceRow\"><td style=\"background-position:center;background-repeat:no-repeat;background-size:cover;padding-top:0px;padding-bottom:0px\" valign=\"top\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"24\" width=\"100%\" role=\"presentation\"><tbody></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table> </td></tr></tbody></table> </center> <script type=\"text/javascript\" src=\"/_jl20GKF22/ar5tuCr37_/uk1tr6zkXVEX7V/Bi1t/AD/QtcBBOIic\"></script></body></html>";
        sendMail($user['email'], 'Password Reset', $message);

        $response = array(
          'success' => 'The password reset link was sent to your email'
        );
      }
    }
  }

  sleep(1);
  header('Content-Type: application/json');
  echo json_encode($response);
}
?>